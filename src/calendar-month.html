<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="./calendar-day-base.html">
<script src="../bower_components/moment/min/moment.min.js"></script>

<polymer-element name="calendar-month-day" attributes="date events myEvents" extends="calendar-day-base">
	<template>
		<style>
			:host, calendar-month-day {
				border: 1px solid black;
				display: block;
				height: 100%;
			}
			#dayBox {
				min-height: 10px;
			}
			.today {
				background-color: #660000;
				color: white;
			}
			.day {
				background-color: white;
				color: black;
			}
			.selectedDay {
				border: 2px solid #660000;
				background-color: white;
			}
			.event {
				background-color: #ffff99;
				color: black;
				overflow: hidden;
			}
		</style>
		<div id="dayBox" class="{{classFor(date, selected)}}" on-tap="{{tapped}}">
			<div>{{date | formatDate}}</div>
			<template repeat="{{event in myEvents}}">
				<div class="event">{{event | formatEvent}}</div>
			</template>
		</div>
	</div>
</template>
<script>
	Polymer({
		created: function() {
			this.selected = false;
		},
		classFor: function(date, selected) {
			if (moment(date).isSame(moment(), 'day'))
				return 'today';
			if (this.selected)
				return 'selectedDay';
			return 'day';
		},
		formatDate: function(date) {
			return moment(date).date();
		},
		formatEvent: function(event) {
			return event.start.format('h:mm') + ' ' + event.title;
		},
		myEventsChanged: function(oldVal, newVal) {
			console.log('myEventsChanged');
		},
		// Fire custom event when tapped to permit main calendar to manage
		// selections.
		tapped: function() {
			this.selected = true;
			this.fire('day-selected', this);
		}
	});
</script>
</polymer-element>

<polymer-element name="calendar-month" attributes="curDate events header" on-day-selected="{{daySelected}}" vertical layout>
	<template>
		<style> 
			:host {
				display: block;
				height: 100%;
			}
			.header {
				background-color: grey; 
				color: white;
			}
			.dayBox {
				border: solid black 1px;
				background-color: white;
				color: black;
			}	
			.dayBoxToday {
				background-color: darkgrey;
				color: white;
			}
			.dayBoxCurrent {
				border: 2px solid black;
			}
			.event {
				background-color: #ffff99;
				color: black;
				overflow: hidden;
			}
		</style>
		<template if="{{header != null}}">
			<div horizontal layout center center-justified class="header">
				<div flex></div>
				<core-icon-button icon="chevron-left" on-tap="{{monthBack}}"></core-icon-button>
				<div>{{formatMonth(curDate)}}</div>
				<core-icon-button icon="chevron-right" on-tap="{{monthForward}}"></core-icon-button>
				<div flex></div>
				<core-icon-button icon="today" on-tap="{{todayTapped}}"></core-icon-button>
			</div>
		</template>
		<template repeat="{{week in weeks}}">
			<div horizontal layout flex>
				<template repeat="{{day in weekDays}}">
					<div flex id="dayBox{{day + week * 7}}" class="{{classFor(curDate, week, day)}}" date="{{dateFor(week, day)}}"  on-tap="{{dayBoxTapped}}">
						<div>{{curDate | formatDate(week, day)}}</div>
					</div>
				</template>
			</div>
		</template>
	</template>
	<script>
		Polymer({
			created: function() {
				// Convert curDate to moment if needed and set to 12:00 AM
				// Defaults to now
				this.curDate = this.curDate ? moment(this.curDate) : moment();
				this.weeks = [0, 1, 2, 3, 4, 5];
				this.weekDays = [0,1,2,3,4,5,6];
			},
			ready: function() {
				//				this.selectedDay = this.dayBoxForDate(this.curDate);
				//				this.selectedDay.selected = true;
			},
			firstDateInWeek: function(week) {
				var monthFirstDay = moment(this.curDate).startOf('month');
				return moment(monthFirstDay).startOf('week').add(week, 'w');
			},
			get firstDateInCalendar() {
				return this.curDate.startOf('month').startOf('week');
			},
			get lastDateInCalendar() {
				return moment(this.firstDateInCalendar).add(7 * this.weeks.length - 1, 'd');
			},
			dayBoxFor: function(weekNum, dayNum) {
				if (weekNum < 0 || weekNum >= this.weeks.length || dayNum < 0 || dayNum > 6)
					return;
				return this.shadowRoot.querySelector('#dayBox' + (dayNum + 7 * weekNum));
			},
			dayBoxForDate: function(date) {
				var refDate = moment(date).startOf('day');
				if (refDate < this.firstDateInCalendar || refDate > this.lastDateInCalendar)
					return;
				var weekNum = Math.floor(refDate.diff(this.firstDateInCalendar, 'days') / 7);
				if (weekNum >= this.weeks.length) return null;
				var dayNum = Math.floor(refDate.diff(this.firstDateInWeek(weekNum), 'd'));
				return this.dayBoxFor(weekNum, dayNum);
			},
			dateFor: function(weekNum, dayNum) {
				return this.firstDateInWeek(weekNum).add(dayNum, 'd');
			},
			monthBack: function() {
				this.curDate = moment(this.curDate).subtract(1, 'month');
			},
			monthForward: function() {
				this.curDate = moment(this.curDate).add(1, 'month');
			},
			curDateChanged: function(oldDate, newDate) {
				// Ensure that curDate is a moment object
				if (!moment.isMoment(this.curDate))
					this.curDate = moment(this.curDate);
				// Make the current date selected 
				//				this.selectedDay.selected = false;
				//				this.selectedDay = this.dayBoxForDate(this.curDate);
				//				this.selectedDay.selected = true;
			},
			classFor: function(curDate, week, day) {
				var boxDate = this.dateFor(week, day);
				if (boxDate.isSame(moment(), 'd'))
					return 'dayBoxToday';
				if (boxDate.isSame(curDate))
					return 'dayBoxCurrent';
				return 'dayBox';
			},
			todayTapped: function() {
				this.curDate = moment();
			},
			dayBoxTapped: function(event, day, sender) {
//				if (this.selectedDay) this.selectedDay.selected = false;
//				day.selected = true;
//				this.selectedDay = day;
				this.curDate = moment(sender.getAttribute('date'));
			},
			formatMonth: function(date) {
				return moment(date).format('MMM').toUpperCase();
			},
			formatDate: function(weekNum, dayNum) {
				return this.dateFor(weekNum, dayNum).date();
			}

		});
	</script>
</polymer-element>
