<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-icon-button/core-icon-button.html">

<polymer-element name="calendar-day" attributes="events date startHour showHeader">
	<template>
		<style>
			:host, calendar-day {
				min-width: 150px;
				overflow-y: scroll;
			}
			div[header] {
				background-color: #660000;
				color: #FFFFCC;
				text-align: center;
			}
			div[backgroundGrid] {
				border: 1px solid lightgrey;
				text-align: right;
			}
			div[event] {
				border: 2px solid darkgrey;
				background-color: #FFFF99;
				top: 0;
				left: 0;
				position: relative;
				overflow: hidden;
			}
			div[spacer] {
				color: transparent;
			}

		</style>

		<template if="{{showHeader}}">
			<div header layout horizontal center center-justified>
				<core-icon-button icon="chevron-left" on-tap="{{dayBack}}"></core-icon-button>
				<div header>{{date | formatDate}}</div>
				<core-icon-button icon="chevron-right" on-tap="{{dayForward}}"></core-icon-button>
			</div>
		</template>
		<div layout horizontal flex>
			<div vertical layout flex>
				<template repeat="{{hour in hours}}">
					<div flex id="gridRow{{hour.value}}" backgroundGrid></div>
				</template>
			</div>
			<div vertical layout>
				<template repeat="{{hour in hours}}">
					<div id="hour{{hour.value}}" backgroundGrid>{{hour.label}}</div>
					</template >
				</div>
			</div>
		</div>
		<div layout horizontal flex eventlayout>
			<template repeat="{{event, eventIdx in eventsForDate(events, date) }}">
				<div flex event id="event{{eventIdx}}" style="{{event | eventStyle | styleObject }}">{{event.venue.name}}</div>
			</template>
			<div spacer>25pm</div>
		</div>		
	</template>
	<script>
		Polymer({
			startHour: 0,
			date: moment(), 
			ready: function() {
				this.hours = [];
				var m = moment();
				for (var i = this.startHour; i < 24; i++) {
					m.hour(i);
					this.hours.push({value: i, label: m.format('ha') });
				}
			},
			formatDate: function(date) {
				if (date) return date.format('ddd, MMM D').toUpperCase();
			},
			eventStyle: function(event) {
				/*  Compute the height of the event element: for now, equal to the
						vertical distance from from the top of the starting hour's row to
						the bottom of the ending hour's row.
						TODO: reflect fractional hours in start/end
				 */
				var start = moment(event.start);
				var end = moment(event.end);
				var topHour = start.hour();
				if (topHour < this.startHour) topHour = this.startHour;
				var botHour = end.hour();
				var lastDiv = this.shadowRoot.querySelector('#hour23');

				var top = this.shadowRoot.querySelector('#hour' + topHour).offsetTop;
				var botDiv;
				if (start.isSame(end, 'd')) {
					botDiv = this.shadowRoot.querySelector('#hour' + botHour);
				}
				else {
					botDiv = lastDiv;
				}
				var bot = botDiv.offsetTop + botDiv.offsetHeight;
				var height = bot - top;
				/*	Since this is a relatively positioned element, compute an offset
						that will move it up by the distance from the top of the starting
						hour row to the bottom of the bottom of the last row, where it
						naturally would be positioned otherwise.
				 */
				var topOffset = top - (lastDiv.offsetTop + lastDiv.offsetHeight);
				var left = 0;
				return { top: topOffset + 'px', height: height + 'px', left: left + 'px' };
			},
			eventsForDate: function(events, date) {
				//console.log('events for date called with events ' + events + ' date ' + date);
				if (!events || events.length < 1)
					return [];
				var ar = (function(d) { 
					return events.filter(function(el, idx, ar) {
						return moment(el.start).isSame(d, 'd');
					});
				})(date);
				return ar;
			},
			dayBack: function() {
				// This syntax, by assigning a new object to the bound property, forces
				// updates and change events.
				this.date = moment(this.date).subtract(1, 'd');
			},
			dayForward: function() {
				this.date = moment(this.date).add(1, 'd');
			}
		});
	</script>
</polymer-element>

<polymer-element name="calendar-days" attributes="startDate daysToShow events" horizontal layout>
	<template>
		<style>
			div[aDay] {
				border: 1px solid #330033;
			}
		</style>
		<template repeat="{{day in days}}">
			<div flex layout vertical aDay>
				<calendar-day flex date="{{day}}" events="{{events}}" startHour="12" showHeader="true"></calendar-day>
			</div>
		</template>
	</template>
	<script>
		Polymer( {
			ready: function() {
				this.days = [];
				for (i = 0; i < this.daysToShow; i++) {
					this.days.push(moment(this.startDate).startOf('d').add(i, 'd'));
				}
			}
		});
	</script>
</polymer-element>
