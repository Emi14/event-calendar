<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../core-icon-button/core-icon-button.html">
<link rel="import" href="./calendar-day-base.html">
<script src="../../moment/min/moment.min.js"></script>

<polymer-element name="calendar-day" attributes="events date startHour header scroll" extends="calendar-day-base" layout vertical>
	<template>
		<style>
			:host, calendar-day {
				display: block;
				height: 100%;
			}
			.header {
				background-color: grey;
				color: white;
				text-align: center;
			}
			.scroll {
				overflow-y: scroll;
			}
			.noscroll {
				overflow-y: hidden;
			}
			.backgroundGrid {
				border: 1px solid lightgrey;
				text-align: right;
				min-height: 22px;
			}
			.event {
				border: 2px solid darkgrey;
				background-color: #FFFF99;
				top: 0;
				left: 0;
				position: relative;
				overflow: hidden;
				height: 0;
			}
			div[spacer] {
				color: transparent;
			}
		</style>
		<template if="{{header != null}}">
			<div class="header" layout horizontal center center-justified>
				<core-icon-button icon="chevron-left" on-tap="{{dayBack}}"></core-icon-button>
				<div header>{{date | formatHeader}}</div>
				<core-icon-button icon="chevron-right" on-tap="{{dayForward}}"></core-icon-button>
			</div>
		</template>
		<div flex vertical layout class="{{(scroll != null) ? 'scroll' : 'noscroll'}}">
			<div layout horizontal flex>
				<div vertical layout flex>
					<template repeat="{{hour in hours}}">
						<div flex id="gridRow{{hour.value}}" class="backgroundGrid"></div>
					</template>
				</div>
				<div vertical layout>
					<template repeat="{{hour in hours}}">
						<div flex id="hour{{hour.value}}" class="backgroundGrid">{{hour.label}}</div>
					</template>
				</div>
			</div>
			<div layout horizontal> 
				<template repeat="{{event, eventIdx in myEvents}}">
					<div flex id="event{{eventIdx}}" class="event" style="{{event | eventStyle | styleObject }}">{{event.title}}</div>
				</template>
				<div spacer>25pm</div>
			</div>		
		</div>
	</template>
	<script>
		Polymer({
			created: function() {
				this.startHour = 0;
				this.date = moment(); 
			},
			ready: function() {
				this.hours = [];
				var m = moment();
				for (var i = this.startHour; i < 24; i++) {
					m.hour(i);
					this.hours.push({value: i, label: m.format('ha') });
				}
			},
			formatHeader: function(date) {
				if (date) {
					return date.format('ddd, MMM D').toUpperCase();
				}
			},
			eventStyle: function(event) {
				/*  Compute the height of the event element: for now, equal to the
						vertical distance from from the top of the starting hour's row to
						the bottom of the ending hour's row.
TODO: reflect fractional hours in start/end
				 */
				var start = moment(event.start);
				var end = moment(event.end);
				var topHour = start.hour();
				if (topHour < this.startHour) topHour = this.startHour;
				var botHour = end.hour();
				var lastDiv = this.shadowRoot.querySelector('#hour23');

				var top = this.shadowRoot.querySelector('#hour' + topHour).offsetTop;
				var botDiv;
				if (start.isSame(end, 'd')) {
					botDiv = this.shadowRoot.querySelector('#hour' + botHour);
				}
				else {
					botDiv = lastDiv;
				}
				var bot = botDiv.offsetTop + botDiv.offsetHeight;
				var height = bot - top;
				/*	Since this is a relatively positioned element, compute an offset
						that will move it up by the distance from the top of the starting
						hour row to the bottom of the bottom of the last row, where it
						naturally would be positioned otherwise.
				 */
				var topOffset = top - (lastDiv.offsetTop + lastDiv.offsetHeight);
				// Align the element to the left.
				var left = 0;
				return { visibility: 'visible', top: topOffset + 'px', height: height + 'px', left: left + 'px' };
			},
			dayBack: function() {
				// This syntax, by assigning a new object to the bound property, forces
				// updates and change events.
				this.date = moment(this.date).subtract(1, 'd');
			},
			dayForward: function() {
				this.date = moment(this.date).add(1, 'd');
			}
		});
	</script>
</polymer-element>


